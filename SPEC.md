# Maven Repository Platform Specification

**Project:** `maven.kaf.sh`
**Repository:** `iamkaf/maven-repo`
**Owner:** iamkaf

---

## 1. Overview

This project implements a **self-hosted, immutable Maven repository platform** backed by Cloudflare infrastructure. It provides:

* Immutable Maven artifact hosting
* Anonymous consumption via standard Maven/Gradle tooling
* Authenticated, CI-only publishing
* A modern, browsable frontend UI
* A read-only metadata API
* Fully declarative infrastructure (Infrastructure as Code)

The system intentionally replaces traditional JVM-based repository managers (e.g. Nexus, Artifactory) with a **simpler, cheaper, and more maintainable architecture**.

---

## 2. Goals and Non-Goals

### 2.1 Goals

* Host multiple Maven libraries under the `com.iamkaf` group
* Support standard Maven and Gradle dependency resolution
* Allow anonymous, token-free artifact downloads
* Enforce immutable artifact versions
* Provide a browsable web UI for humans
* Require authentication **only** for publishing
* Operate entirely on serverless / managed infrastructure
* Be fully reproducible from source via Infrastructure as Code

---

### 2.2 Non-Goals

* Supporting authenticated consumers
* Supporting private dependencies
* Acting as a general-purpose artifact manager
* Allowing artifact mutation or deletion
* Supporting non-Maven repository layouts
* Supporting `-SNAPSHOT` versions
* Providing server-side builds or CI functionality
* Replacing Maven Central (this platform complements it)

> **Rationale (authenticated consumers):**
> This repository is intended for public libraries. Introducing authenticated consumers complicates dependency resolution, caching, and tooling compatibility and is unnecessary for the intended use case.

> **Rationale (SNAPSHOT versions):**
> SNAPSHOT artifacts are mutable and conflict with immutability guarantees, CDN caching, and reproducible builds. Pre-releases should use semantic versioning (e.g. `1.2.0-beta.1`) instead.

---

## 3. High-Level Architecture

```
Browser
  └─ https://maven.kaf.sh
        ├─ /            → Frontend (SPA)
        ├─ /api/*       → Cloudflare Worker (read-only API)
        └─ /com/...     → Maven artifacts (Cloudflare R2 + CDN)
```

### 3.1 Core Components

| Component        | Technology        | Responsibility                         |
| ---------------- | ----------------- | -------------------------------------- |
| Artifact Storage | Cloudflare R2     | Immutable Maven artifacts              |
| Metadata API     | Cloudflare Worker | Maven-aware, read-only metadata access |
| Frontend         | Static SPA (Vite) | Human browsing & discovery             |
| DNS & CDN        | Cloudflare        | TLS, caching, routing                  |
| IaC              | Terraform         | Declarative infrastructure             |

---

## 4. Domain & Routing

### 4.1 Canonical Domain

```
https://maven.kaf.sh
```

### 4.2 URL Responsibilities

| Path      | Description                               |
| --------- | ----------------------------------------- |
| `/`       | Frontend SPA                              |
| `/api/*`  | JSON API exposed by Worker                |
| `/com/**` | Maven artifacts (binary + metadata files) |

---

## 5. Artifact Model

### 5.1 Maven Coordinates

* **groupId:** `com.iamkaf`
* **artifactId:** per-project (e.g. `amber`)
* **version:** semantic versioning, immutable

---

### 5.2 Storage Layout (R2)

```
com/
└── iamkaf/
    ├── amber/
    │   ├── maven-metadata.xml
    │   └── 1.2.0/
    │       ├── amber-1.2.0.jar
    │       ├── amber-1.2.0.pom
    │       ├── amber-1.2.0.jar.sha1
    │       ├── amber-1.2.0.pom.sha1
    │       └── amber-1.2.0.jar.asc (optional)
    └── other-artifact/
```

Artifacts are:

* Immutable after publication
* Served directly via CDN
* Never proxied through the API or frontend

---

### 5.3 Checksums

* Checksum files (`.sha1`, optionally `.sha256`) are **required**
* Generated by Maven/Gradle during publishing
* Uploaded alongside artifacts by CI
* Never generated or modified by the Worker or frontend

---

## 6. Publishing Model

### 6.1 Publishing Actors

* CI pipelines only
* No direct human uploads
* Each library repository owns its publishing workflow

---

### 6.2 Publishing Flow

1. Build artifact
2. Publish to local Maven repository (`publishToMavenLocal`)
3. Validate version immutability
4. Sync artifacts and metadata to R2 bucket
5. Fail the pipeline if immutability is violated

---

### 6.3 Version Immutability Enforcement

> **Version immutability is enforced at publish time by CI.**

Before uploading artifacts for a given `(groupId, artifactId, version)`, the publishing pipeline checks for the existence of the corresponding version directory in the R2 bucket.

* If the version directory exists, the publish **fails**
* No files are uploaded or overwritten
* R2 object versioning or locking is **not** used

This ensures deterministic, early failure and avoids partial or corrupted releases.

---

### 6.4 Authentication

* R2 write access via scoped API token
* Token stored as CI secret
* No read credentials required

---

## 7. Maven Metadata

### 7.1 Metadata Generation

* `maven-metadata.xml` is generated by Maven/Gradle during publishing
* CI uploads metadata as part of the artifact sync
* The Worker never creates, modifies, or regenerates metadata

This ensures correctness and compatibility with Maven/Gradle tooling.

---

## 8. Read-Only Metadata API (Worker)

### 8.1 Purpose

The Worker provides a **controlled, Maven-aware projection** of repository metadata for frontend consumption. It prevents exposing raw object storage listings and enforces a read-only contract.

---

### 8.2 API Endpoints

| Endpoint                                            | Description                                    | Status  |
| --------------------------------------------------- | ---------------------------------------------- | ------- |
| `GET /api/groups`                                   | List top-level groups                          | ✅ Done |
| `GET /api/artifacts?group=com.iamkaf`               | List artifacts and subgroups in a group        | ✅ Done |
| `GET /api/versions?group=...&artifact=...`          | List versions with latest/release badges       | ✅ Done |
| `GET /api/files?group=...&artifact=...&version=...` | List files                                     | ✅ Done |
| `GET /api/latest?group=...&artifact=...`            | Resolve latest version                         | ✅ Done |

---

### 8.3 Error Handling

The API follows standard HTTP semantics:

* `400 Bad Request` for malformed or incomplete requests
* `404 Not Found` when a group, artifact, or version does not exist
* `500 Internal Server Error` for unexpected failures

Error responses may include a short JSON message but are not guaranteed to be stable for programmatic consumption.

---

### 8.4 API Characteristics

* JSON only
* Read-only
* No authentication
* Aggressively cached
* No artifact proxying
* No mutation capabilities

---

## 9. Frontend (SPA)

### 9.1 Purpose

Provide a modern, user-friendly interface for browsing hosted Maven artifacts.

---

### 9.2 Features

* Browse groups → artifacts → versions
* View available files per version
* Copy dependency snippets (Gradle & Maven)
* Direct download links
* Display latest version (once implemented)
* Optional prefix-based search

---

### 9.3 Hosting

* Built as static assets
* Hosted via Cloudflare Pages
* Served at `https://maven.kaf.sh/`

---

## 10. Infrastructure as Code

### 10.1 Source of Truth

All infrastructure is managed via Terraform.

---

### 10.2 Managed Resources

* Cloudflare R2 bucket
* Cloudflare Worker script & routes
* Cloudflare Pages project
* DNS records for `maven.kaf.sh`

---

### 10.3 Environments

* Production (required)
* Staging (optional)

Environment-specific values are defined via `.tfvars`.

---

## 11. Repository Structure

```
maven-repo/
├── infra/          # Terraform
├── worker/         # Cloudflare Worker
├── frontend/       # SPA
├── scripts/        # Shared operational scripts
└── .github/        # CI/CD workflows
```

This repository is the **control plane** for the entire platform.

---

## 12. Security Model

* Anonymous reads only
* CI-only authenticated writes
* No secret exposure to frontend
* Worker has read-only R2 access
* Artifact immutability enforced before upload

---

## 13. Caching & Performance

* CDN-backed artifact delivery
* Long-lived cache headers for immutable versions
* API responses cached at the edge
* Frontend fully static

Expected scale: effectively unlimited.

---

## 14. Design Decisions

### 14.1 Why not Nexus or Artifactory?

JVM-based repository managers are operationally heavy, expensive to host, and provide far more functionality than required for immutable, public artifacts.

---

### 14.2 Why object storage + CDN?

Maven artifacts are immutable, cacheable blobs. Object storage with a CDN maps directly to this access pattern and eliminates operational overhead.

---

### 14.3 Why a read-only Worker API?

Browsing and metadata projection are orthogonal to artifact storage. A read-only API preserves immutability and avoids coupling UI concerns to storage internals.

---

### 14.4 Why no authenticated consumers?

Public libraries do not benefit from authenticated consumption. Requiring authentication complicates dependency resolution, breaks caching, and reduces usability.

---

## 15. Success Criteria

The project is considered complete when:

* Libraries can be published via CI
* Artifacts are consumable anonymously via Maven/Gradle
* Frontend accurately reflects repository contents
* Infrastructure can be recreated from scratch via Terraform
* No manual operational steps are required

---

## 16. Summary

This project delivers a **modern, minimal, and maintainable Maven repository platform** using Cloudflare-native primitives. It preserves full compatibility with Maven and Gradle while intentionally avoiding legacy repository managers and operational complexity.
